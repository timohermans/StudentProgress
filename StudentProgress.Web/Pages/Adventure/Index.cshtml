@page "{id:int}"
@model StudentProgress.Web.Pages.Adventure.Index

<div class="stack">
    <h2 class="heading">
        <span class="heading__highlight">@(Model.Adventure.Name)</span>'s adventure
    </h2>

    <nav class="mb-3">
        Jump to <a class="link" href="#people">Adventurers</a> / <a class="link" href="#">Quests</a> / <a class="link" href="#">Logs</a>
    </nav>

    <section>
        <h3 class="heading">People</h3>
        <ul id="people" class="reel" x-ref="reel" x-data="{ selected: @(Model.Person?.Id.ToString() ?? "null") }">
            @foreach (var person in Model.Adventure.People.OrderBy(p => p.FirstName))
            {
                <li class='reel__item'
                    x-data="{ 
                id: @person.Id,
                hasFocus: false,
                showOptions: false,
                showIcon: false 
            }"
                    x-init="if(id !== selected) return;
                    $refs.reel.scrollLeft = $el.offsetLeft - ($el.offsetWidth / 2);
             "
                    :class="selected === id && 'reel__item--selected'"
                    @@click="selected = id"
                    @@mouseenter="hasFocus = showIcon = true"
                    @@mouseleave="hasFocus = false; if(showOptions === false) showIcon = false"
                    hx-trigger="click"
                    hx-get="@Url.Page("Index", new { id = Model.Adventure.Id, personId = person.Id })"
                    hx-target="body"
                    hx-push-url="true">
                    <img src="@person.ImageSource" class="reel__cover" alt="@person.Name" height="150">
                    <div class="row row--justify-between reel__content">
                        <div>@person.FirstName</div>

                        <div class="image-link image-link--small"
                             :class="showIcon ? 'image-link--visible' : 'image-link--hidden'"
                             x-cloak
                             x-transition
                             @@click.stop="showOptions = !showOptions"
                             @@click.outside="showOptions = false; if(!hasFocus) showIcon = false;">
                            <img class="image-link__icon" src="~/images/037-binoculars-1.png" alt="adventure options">
                            <div class="image-link__border" :class="showOptions && 'image-link__border--highlight'"></div>
                            <div id="adventure-@(person.Id)-options" class="image-link__content image-link__content--go-up fade-me-in fade-me-out" :class="showOptions && 'image-link__content--visible'">
                                <ul>
                                    <li>
                                        <a class="link" href="#"
                                           hx-confirm="You sure you want to remove this person from the adventure?"
                                           hx-delete="@Url.Page("Index", "RemovePerson", new { id = Model.Adventure.Id, personId = person.Id })">
                                            Delete
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>

                    </div>
                </li>
            }
        </ul>
    </section>

    <section id="quests">
        <h3 class="heading">
            @if (Model.Person != null)
            {
                <span class="heading__highlight">@(Model.Person?.FirstName)'s</span>
            }
            @(" ")Quest log
        </h3>

        <ol>
            @foreach (var questLine in Model.Adventure.QuestLines)
            {
                <li>
                    @questLine.Name
                </li>
            }
        </ol>
    </section>
</div>