@page
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using StudentProgress.Core.Entities
@model StudentProgress.Web.Pages.Progress.QuickAdd

@{
  ViewData["Title"] = "Quick add";
}

@section Styles
{
  <link rel="stylesheet" href="~/css/quick-add.css">
}

<h1>Quick add</h1>

<form id="groupForm" method="get">
  <p>
    <label for="groupId">Group</label>
    <select class="form-control" id="groupId" name="groupId" asp-items="Model.Groups"></select>
  </p>
</form>

@if (Model.Group != null)
{
  <form>
    @Html.HiddenFor(m => m.Command.GroupId)
    <p>
      <label asp-for="Command.GroupId">Milestone</label>
      <select class="form-control" asp-for="Command.MilestoneId" asp-items="Model.Group.Milestones.OrderBy(m => m.LearningOutcome).ThenBy(m => m.Artefact).Select(m => new SelectListItem(m.ToString(), m.Id.ToString()))"></select>
    </p>

    <section>
      <h2>Students</h2>

      <ul class="students grid">
        @foreach (var (student, index) in Model.Group.Students.WithIndex())
        {
          <input type="hidden" name="Command.Students[@index].StudentId" value="@student.Id"/>
          <li class="student card">
            <div class="student-head d-flex">
              <img class="rounded-circle" src="@(student.AvatarPath != null ? $"/media/{student.AvatarPath}" : "/images/avatar-placeholder.png")" width="50" height="50" alt="@student.Name"/>
              <div>
                <div class="">@student.Name</div>
                <div class="text-muted">@student.ProgressUpdates.Count() notes</div>
              </div>
            </div>
            <div class="card-body">
              <ul class="feelings">
                @foreach (Rating rating in Enum.GetValues<Rating>())
                {
                  <input type="radio" class="btn-check"
                         name="Command.Students[@index].Rating"
                         id="student-@student.Id-@rating"
                         value="@rating"/>
                  <label class="btn btn-outline-@(MilestoneUiHelper.RatingColor(rating) ?? "light")" for="student-@student.Id-@rating">@rating.ToFriendlyString()</label>
                }
              </ul>
              <div>
                <textarea class="form-control" placeholder="Comment"></textarea>
              </div>
            </div>
          </li>
        }
      </ul>
    </section>

  </form>
}

@section Scripts {
  <script>
    const groupSelect = document.querySelector("#groupForm select");
    
    groupSelect.addEventListener("change", (event) => {
      event.target.form.submit();
    });
  </script>
}